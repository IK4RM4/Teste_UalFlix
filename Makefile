# Makefile para UALFlix - Kubernetes com 3 N√≥s
# FUNCIONALIDADE 2: IMPLEMENTA√á√ÉO DE CLUSTER DE COMPUTADORES

NAMESPACE=ualflix
NODES=3
MEMORY=4096
CPUS=2

# Cores para output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

.PHONY: help cluster-start cluster-stop build deploy clean status logs test scale

help: ## Mostrar ajuda
	@echo "${BLUE}UALFlix - Kubernetes com 3 N√≥s${NC}"
	@echo "${YELLOW}Comandos dispon√≠veis:${NC}"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  ${GREEN}%-15s${NC} %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# ========================================
# FUNCIONALIDADE 2: CLUSTER SETUP
# ========================================

cluster-start: ## Iniciar cluster Minikube com 3 n√≥s
	@echo "${BLUE}üöÄ Iniciando cluster Kubernetes com $(NODES) n√≥s...${NC}"
	@minikube delete 2>/dev/null || true
	@minikube start \
		--driver=docker \
		--nodes=$(NODES) \
		--cpus=$(CPUS) \
		--memory=$(MEMORY) \
		--disk-size=20g \
		--kubernetes-version=v1.28.0
	@echo "${GREEN}‚úÖ Cluster iniciado com sucesso!${NC}"
	@make addons-enable

addons-enable: ## Habilitar addons necess√°rios
	@echo "${BLUE}üîß Habilitando addons...${NC}"
	@minikube addons enable ingress
	@minikube addons enable dashboard
	@minikube addons enable metrics-server
	@minikube addons enable default-storageclass
	@minikube addons enable storage-provisioner
	@echo "${GREEN}‚úÖ Addons habilitados!${NC}"

cluster-stop: ## Parar cluster Minikube
	@echo "${RED}üõë Parando cluster...${NC}"
	@minikube stop

cluster-delete: ## Deletar cluster Minikube
	@echo "${RED}üóëÔ∏è  Deletando cluster...${NC}"
	@minikube delete

cluster-info: ## Mostrar informa√ß√µes do cluster
	@echo "${BLUE}üìä Informa√ß√µes do Cluster:${NC}"
	@kubectl cluster-info
	@echo "\n${BLUE}üìã N√≥s do Cluster:${NC}"
	@kubectl get nodes -o wide

# ========================================
# FUNCIONALIDADE 3: VIRTUALIZA√á√ÉO
# ========================================

docker-env: ## Configurar ambiente Docker do Minikube
	@echo "${BLUE}üê≥ Configurando Docker environment...${NC}"
	@eval $$(minikube docker-env)
	@echo "${GREEN}‚úÖ Docker environment configurado!${NC}"

build: docker-env ## Build de todas as imagens Docker
	@echo "${BLUE}üèóÔ∏è  Building Docker images...${NC}"
	@eval $$(minikube docker-env) && \
	docker build -t frontend:latest ./frontend/ && \
	docker build -t authentication_service:latest ./authentication_service/ && \
	docker build -t catalog_service:latest ./catalog_service/ && \
	docker build -t streaming_service:latest ./streaming_service/ && \
	docker build -t admin_service:latest ./admin_service/ && \
	docker build -t video_processor:latest ./video_processor/
	@echo "${GREEN}‚úÖ Todas as imagens foram constru√≠das!${NC}"

images: ## Listar imagens Docker no Minikube
	@echo "${BLUE}üì¶ Imagens Docker dispon√≠veis:${NC}"
	@eval $$(minikube docker-env) && docker images | grep -E "(frontend|authentication_service|catalog_service|streaming_service|admin_service|video_processor|mongo|rabbitmq|nginx)"

# ========================================
# FUNCIONALIDADE 4: IMPLEMENTA√á√ÉO NA CLOUD (Kubernetes)
# ========================================

deploy: build ## Deploy completo da aplica√ß√£o
	@echo "${BLUE}üöÄ Iniciando deploy da aplica√ß√£o UALFlix...${NC}"
	@make deploy-namespace
	@make deploy-secrets
	@make deploy-database
	@make deploy-messaging
	@make deploy-services
	@make deploy-frontend
	@make deploy-gateway
	@make deploy-monitoring
	@echo "${GREEN}‚úÖ Deploy completo realizado!${NC}"
	@make status

deploy-namespace: ## Criar namespace
	@echo "${YELLOW}üìÅ Criando namespace...${NC}"
	@kubectl apply -f k8s/namespace.yaml

deploy-secrets: ## Aplicar secrets e configmaps
	@echo "${YELLOW}üîê Aplicando secrets e configmaps...${NC}"
	@kubectl apply -f k8s/secrets.yaml

deploy-database: ## Deploy MongoDB
	@echo "${YELLOW}üóÑÔ∏è  Deploying MongoDB...${NC}"
	@kubectl apply -f k8s/database/
	@echo "Aguardando MongoDB ficar pronto..."
	@kubectl wait --for=condition=ready pod -l app=mongodb -n $(NAMESPACE) --timeout=300s || true

deploy-messaging: ## Deploy RabbitMQ
	@echo "${YELLOW}üê∞ Deploying RabbitMQ...${NC}"
	@kubectl apply -f k8s/messaging/
	@echo "Aguardando RabbitMQ ficar pronto..."
	@kubectl wait --for=condition=ready pod -l app=rabbitmq -n $(NAMESPACE) --timeout=300s || true

deploy-services: ## Deploy servi√ßos da aplica√ß√£o
	@echo "${YELLOW}üîß Deploying application services...${NC}"
	@kubectl apply -f k8s/services/auth/
	@kubectl apply -f k8s/services/catalog/
	@kubectl apply -f k8s/services/streaming/
	@kubectl apply -f k8s/services/admin/
	@kubectl apply -f k8s/services/processor/
	@echo "Aguardando servi√ßos ficarem prontos..."
	@kubectl wait --for=condition=available deployment --all -n $(NAMESPACE) --timeout=300s || true

deploy-frontend: ## Deploy React Frontend
	@echo "${YELLOW}‚öõÔ∏è  Deploying React Frontend...${NC}"
	@kubectl apply -f k8s/frontend/
	@kubectl wait --for=condition=available deployment/frontend -n $(NAMESPACE) --timeout=300s || true

deploy-gateway: ## Deploy NGINX Gateway (Roteador Principal)
	@echo "${YELLOW}üåê Deploying NGINX Gateway...${NC}"
	@kubectl apply -f k8s/ingress/nginx-configmap.yaml
	@kubectl apply -f k8s/ingress/nginx-deployment.yaml
	@kubectl apply -f k8s/ingress/nginx-service.yaml
	@kubectl wait --for=condition=available deployment/nginx-gateway -n $(NAMESPACE) --timeout=300s || true

deploy-monitoring: ## Deploy Prometheus e Grafana
	@echo "${YELLOW}üìä Deploying monitoring stack...${NC}"
	@kubectl apply -f k8s/monitoring/ || true
	@echo "Aguardando monitoring ficar pronto..."
	@kubectl wait --for=condition=available deployment/prometheus -n $(NAMESPACE) --timeout=300s || true
	@kubectl wait --for=condition=available deployment/grafana -n $(NAMESPACE) --timeout=300s || true

# ========================================
# FUNCIONALIDADE 7: AVALIA√á√ÉO DE DESEMPENHO
# ========================================

status: ## Verificar status do sistema
	@echo "${BLUE}üìä Status do Sistema UALFlix:${NC}"
	@echo "\n${YELLOW}üè∑Ô∏è  Namespace:${NC}"
	@kubectl get namespace $(NAMESPACE)
	@echo "\n${YELLOW}üì¶ Pods:${NC}"
	@kubectl get pods -n $(NAMESPACE) -o wide
	@echo "\n${YELLOW}üîó Services:${NC}"
	@kubectl get services -n $(NAMESPACE)
	@echo "\n${YELLOW}üöÄ Deployments:${NC}"
	@kubectl get deployments -n $(NAMESPACE)
	@echo "\n${YELLOW}‚öñÔ∏è  HPA (Auto-scaling):${NC}"
	@kubectl get hpa -n $(NAMESPACE) || echo "Nenhum HPA configurado ainda"

pods: ## Listar pods com detalhes
	@kubectl get pods -n $(NAMESPACE) -o wide

services: ## Listar servi√ßos
	@kubectl get services -n $(NAMESPACE) -o wide

logs: ## Ver logs dos servi√ßos principais
	@echo "${BLUE}üìã Logs dos Servi√ßos:${NC}"
	@echo "\n${YELLOW}üåê NGINX Gateway:${NC}"
	@kubectl logs -n $(NAMESPACE) deployment/nginx-gateway --tail=10 || true
	@echo "\n${YELLOW}üîê Authentication Service:${NC}"
	@kubectl logs -n $(NAMESPACE) deployment/auth-service --tail=10 || true
	@echo "\n${YELLOW}üìÅ Catalog Service:${NC}"
	@kubectl logs -n $(NAMESPACE) deployment/catalog-service --tail=10 || true

logs-follow: ## Seguir logs em tempo real
	@echo "${BLUE}üìã Seguindo logs do NGINX Gateway...${NC}"
	@kubectl logs -f -n $(NAMESPACE) deployment/nginx-gateway

# ========================================
# FUNCIONALIDADE 6: REPLICA√á√ÉO DE SERVI√áOS
# ========================================

scale: ## Escalar servi√ßos (uso: make scale SERVICE=catalog-service REPLICAS=5)
	@echo "${BLUE}‚öñÔ∏è  Escalando $(SERVICE) para $(REPLICAS) r√©plicas...${NC}"
	@kubectl scale deployment $(SERVICE) --replicas=$(REPLICAS) -n $(NAMESPACE)
	@kubectl get deployment $(SERVICE) -n $(NAMESPACE)

scale-all: ## Escalar todos os servi√ßos principais
	@echo "${BLUE}‚öñÔ∏è  Escalando todos os servi√ßos...${NC}"
	@kubectl scale deployment auth-service --replicas=3 -n $(NAMESPACE)
	@kubectl scale deployment catalog-service --replicas=4 -n $(NAMESPACE)
	@kubectl scale deployment streaming-service --replicas=4 -n $(NAMESPACE)
	@kubectl scale deployment admin-service --replicas=2 -n $(NAMESPACE)
	@kubectl scale deployment nginx-gateway --replicas=3 -n $(NAMESPACE)
	@echo "${GREEN}‚úÖ Escalamento conclu√≠do!${NC}"

scale-down: ## Reduzir r√©plicas para economizar recursos
	@echo "${YELLOW}‚¨áÔ∏è  Reduzindo r√©plicas...${NC}"
	@kubectl scale deployment auth-service --replicas=1 -n $(NAMESPACE)
	@kubectl scale deployment catalog-service --replicas=2 -n $(NAMESPACE)
	@kubectl scale deployment streaming-service --replicas=2 -n $(NAMESPACE)
	@kubectl scale deployment admin-service --replicas=1 -n $(NAMESPACE)
	@kubectl scale deployment nginx-gateway --replicas=2 -n $(NAMESPACE)

# ========================================
# ACESSO √Ä APLICA√á√ÉO
# ========================================

url: ## Obter URL da aplica√ß√£o
	@echo "${BLUE}üåê URLs de Acesso:${NC}"
	@echo "${GREEN}Aplica√ß√£o Principal (NGINX Gateway):${NC}"
	@minikube service nginx-gateway --namespace $(NAMESPACE) --url
	@echo "\n${GREEN}Prometheus:${NC}"
	@minikube service prometheus-service --namespace $(NAMESPACE) --url || true
	@echo "\n${GREEN}Grafana:${NC}"
	@minikube service grafana-service --namespace $(NAMESPACE) --url || true

open: ## Abrir aplica√ß√£o no browser
	@echo "${BLUE}üåê Abrindo UALFlix no browser...${NC}"
	@minikube service nginx-gateway --namespace $(NAMESPACE)

dashboard: ## Abrir Kubernetes Dashboard
	@echo "${BLUE}üìä Abrindo Kubernetes Dashboard...${NC}"
	@minikube dashboard

tunnel: ## Iniciar tunnel para LoadBalancer (deixar rodando em terminal separado)
	@echo "${BLUE}üöá Iniciando Minikube tunnel...${NC}"
	@echo "${YELLOW}‚ö†Ô∏è  Mantenha este comando rodando em um terminal separado${NC}"
	@minikube tunnel

port-forward: ## Port forward para desenvolvimento
	@echo "${BLUE}üîå Iniciando port forwards...${NC}"
	@echo "${YELLOW}NGINX Gateway: http://localhost:8080${NC}"
	@kubectl port-forward -n $(NAMESPACE) service/nginx-gateway 8080:8080 &
	@echo "${YELLOW}Prometheus: http://localhost:9090${NC}"
	@kubectl port-forward -n $(NAMESPACE) service/prometheus-service 9090:9090 &
	@echo "${YELLOW}Grafana: http://localhost:3001${NC}"
	@kubectl port-forward -n $(NAMESPACE) service/grafana-service 3001:3000 &
	@echo "${GREEN}‚úÖ Port forwards iniciados em background${NC}"

# ========================================
# TESTES E DEBUG
# ========================================

test: ## Testar conectividade dos servi√ßos
	@echo "${BLUE}üß™ Testando conectividade...${NC}"
	@echo "\n${YELLOW}Testando NGINX Gateway:${NC}"
	@kubectl exec -n $(NAMESPACE) deployment/frontend -- curl -f http://nginx-gateway:8080/health || true
	@echo "\n${YELLOW}Testando Auth Service:${NC}"
	@kubectl exec -n $(NAMESPACE) deployment/frontend -- curl -f http://auth-service:8000/health || true
	@echo "\n${YELLOW}Testando Catalog Service:${NC}"
	@kubectl exec -n $(NAMESPACE) deployment/frontend -- curl -f http://catalog-service:8000/health || true

debug: ## Debug de um pod espec√≠fico (uso: make debug POD=catalog-service)
	@echo "${BLUE}üêõ Entrando no pod $(POD)...${NC}"
	@kubectl exec -it -n $(NAMESPACE) deployment/$(POD) -- /bin/bash

describe: ## Descrever um recurso (uso: make describe RESOURCE=pod/nome-do-pod)
	@kubectl describe -n $(NAMESPACE) $(RESOURCE)

events: ## Ver eventos do cluster
	@echo "${BLUE}üìÖ Eventos do Cluster:${NC}"
	@kubectl get events -n $(NAMESPACE) --sort-by=.metadata.creationTimestamp

top: ## Ver utiliza√ß√£o de recursos
	@echo "${BLUE}üìä Utiliza√ß√£o de Recursos:${NC}"
	@echo "\n${YELLOW}N√≥s:${NC}"
	@kubectl top nodes || echo "Metrics server n√£o dispon√≠vel"
	@echo "\n${YELLOW}Pods:${NC}"
	@kubectl top pods -n $(NAMESPACE) || echo "Metrics server n√£o dispon√≠vel"

# ========================================
# LIMPEZA
# ========================================

clean: ## Remover toda a aplica√ß√£o (manter cluster)
	@echo "${RED}üßπ Removendo aplica√ß√£o UALFlix...${NC}"
	@kubectl delete namespace $(NAMESPACE) --ignore-not-found=true
	@echo "${GREEN}‚úÖ Aplica√ß√£o removida!${NC}"

clean-all: clean cluster-delete ## Remover tudo (aplica√ß√£o + cluster)
	@echo "${RED}üóëÔ∏è  Limpeza completa realizada!${NC}"

restart: ## Reiniciar um deployment (uso: make restart SERVICE=catalog-service)
	@echo "${BLUE}üîÑ Reiniciando $(SERVICE)...${NC}"
	@kubectl rollout restart deployment/$(SERVICE) -n $(NAMESPACE)
	@kubectl rollout status deployment/$(SERVICE) -n $(NAMESPACE)

restart-all: ## Reiniciar todos os deployments
	@echo "${BLUE}üîÑ Reiniciando todos os servi√ßos...${NC}"
	@kubectl rollout restart deployment --all -n $(NAMESPACE)

# ========================================
# FUNCIONALIDADES COMPLETAS
# ========================================

demo: cluster-start deploy url ## Setup completo para demonstra√ß√£o
	@echo "${GREEN}üéâ UALFlix est√° pronto para demonstra√ß√£o!${NC}"
	@echo "${BLUE}Funcionalidades implementadas:${NC}"
	@echo "‚úÖ FUNCIONALIDADE 1: Tecnologias de Sistemas Distribu√≠dos"
	@echo "‚úÖ FUNCIONALIDADE 2: Cluster de Computadores (3 n√≥s)"
	@echo "‚úÖ FUNCIONALIDADE 3: Virtualiza√ß√£o (Docker + Kubernetes)"
	@echo "‚úÖ FUNCIONALIDADE 4: Implementa√ß√£o na Cloud (Kubernetes)"
	@echo "‚úÖ FUNCIONALIDADE 5: Replica√ß√£o de Dados (MongoDB)"
	@echo "‚úÖ FUNCIONALIDADE 6: Replica√ß√£o de Servi√ßos (Load Balancing)"
	@echo "‚úÖ FUNCIONALIDADE 7: Avalia√ß√£o de Desempenho (M√©tricas)"

verify: ## Verificar se tudo est√° funcionando
	@echo "${BLUE}‚úÖ Verifica√ß√£o Final do Sistema:${NC}"
	@echo "\n${YELLOW}1. N√≥s do cluster:${NC}"
	@kubectl get nodes
	@echo "\n${YELLOW}2. Pods em execu√ß√£o:${NC}"
	@kubectl get pods -n $(NAMESPACE)
	@echo "\n${YELLOW}3. Servi√ßos dispon√≠veis:${NC}"
	@kubectl get services -n $(NAMESPACE)
	@echo "\n${YELLOW}4. Testando aplica√ß√£o:${NC}"
	@curl -f $$(minikube service nginx-gateway --namespace $(NAMESPACE) --url)/health 2>/dev/null && echo "‚úÖ Aplica√ß√£o respondendo" || echo "‚ùå Aplica√ß√£o n√£o responde"